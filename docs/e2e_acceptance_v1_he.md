# בדיקות קבלה v1 (CRM עולם הציפויים)

## הכנה
1. ודא שהרצת את `supabase/migrations/20260213_crm_v1.sql`.
2. ודא שהאפליקציה רצה: `npm run dev`.
3. התחבר עם משתמש `authenticated` ב-Supabase.
4. להרצה אוטומטית: `npm run test:e2e`.

## כיסוי אוטומטי בקוד
- קובץ זרימה מלאה: `e2e/crm_v1_acceptance.spec.mjs`
- קובץ תשתיות geocode/route: `e2e/map_route_infra.spec.mjs`
- helpers: `e2e/helpers/auth.mjs`, `e2e/helpers/crm.mjs`

## E2E חובה
1. התחברות
- פעולה: התחבר עם אימייל וסיסמה תקינים.
- צפוי: מעבר לדשבורד, ללא שגיאת התחברות.
- פעולה משלימה: בדסקטופ כפתור התנתקות גלוי ב-Header; במובייל התנתקות מופיעה בתפריט.
- צפוי: שני המצבים עובדים.

2. יצירת לקוח
- פעולה: לקוחות -> לקוח חדש -> שמור.
- צפוי: Toast "נשמר בהצלחה" והלקוח מופיע ברשימה.

3. יצירת הצעת מחיר
- פעולה: הצעות מחיר -> הצעה חדשה -> לפחות שורה אחת.
- צפוי: מעבר לפרטי הצעה וסכום כולל תקין.

4. עריכת טיוטה
- פעולה: פרטי הצעה -> ערוך טיוטה -> שמירה.
- צפוי: שינויים נשמרים.

5. שינוי סטטוס הצעה
- פעולה: שנה ל"נשלחה" ואז ל"אושרה".
- צפוי: הסטטוס מתעדכן בכל פעם.

6. המרה לעבודה
- פעולה: לחץ "המר לעבודה" בהצעה מאושרת.
- צפוי: נוצרה עבודה אחת בלבד ומעבר למסך עבודה.

7. עריכת עבודה מהצעה
- פעולה: ערוך עבודה שנוצרה מהצעה (כולל שורות שירות ואנשי קשר).
- צפוי: שמירה תקינה, הנתונים מתעדכנים.

8. שינוי סטטוס עבודה
- פעולה: עדכן סטטוס עד "בוצע".
- צפוי: הסטטוס מתעדכן ברשימות ובדשבורד.

9. לוח שנה
- פעולה: גרור עבודה לא מתוזמנת ליום בלוח.
- צפוי: עבודה מקבלת `scheduled_start_at` וסטטוס `waiting_execution`.

10. מפה
- פעולה: פתח מפה, סנן לפי סטטוס/טווח תאריכים, תזמן מתוך חלונית.
- צפוי: הנתונים מתעדכנים, מעבר ללוח שנה עם `job_id` מדגיש את העבודה.

11. ETA במפה
- פעולה: בחר עבודה מתוזמנת ראשונה ביום לאותו מבצע.
- צפוי: מקור ETA = `אגס 3, אשדוד`.
- פעולה: בחר עבודה מתוזמנת מאוחרת יותר באותו יום לאותו מבצע.
- צפוי: מקור ETA = "מהעבודה הקודמת".

12. דשבורד
- פעולה: חזור לדשבורד לאחר הפעולות.
- צפוי: ספירות KPI וסטטוסים תואמות לנתונים בפועל.

## ולידציות חובה
1. לקוח ללא שם
- צפוי: "שם מלא הוא שדה חובה".

2. הצעה ללא שורות
- צפוי: "חובה לפחות שורה אחת".

3. quantity <= 0 / unit_price < 0
- צפוי: הודעת שגיאה inline בעברית.

4. עבודה ללא שורות שירות תקינות
- צפוי: "חובה לפחות שורת שירות אחת תקינה".

5. שגיאת שמירה
- פעולה: לגרום לכשל שמירה (למשל ולידציה חסרה/DB reject).
- צפוי: מוצגת הודעת שגיאה עם סיבה מפורטת (code/message/details/hint), ולא הודעה גנרית בלבד.

## תשתית מפה/ניתוב
1. Geocode עם cache
- פעולה: פתח עבודה עם כתובת, רענן מפה.
- צפוי: תוצאות מתקבלות מהר יותר בפעם השנייה.

2. Route עם cache
- פעולה: קריאות חוזרות ל-`/api/route` לאותו origin/destination/time-bucket.
- צפוי: provider יכול לחזור כ-`osrm` או `fallback`, עם שימוש בקאש.

3. Route fallback מבוקר
- פעולה: קריאת `/api/route` למסלול נהיגה לא אפשרי.
- צפוי: provider = `fallback`.

## UI/Locale
1. RTL מלא בכל המסכים.
2. עברית בלבד (ללא טקסט משובש).
3. תאריך: `DD/MM/YYYY`.
4. שעה: `HH:MM`.
5. מטבע: `₪` עם 2 ספרות אחרי נקודה.
