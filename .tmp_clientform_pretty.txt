import React, { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { supabase } from '@/api/supabaseClient';
import { useAuth } from '@/lib/AuthContext';
import {    ArrowRight, Building2, User, Phone, Mail, MapPin, Save, Loader2, Headphones,   CheckCircle, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import { validatePhone, validateEmail, validateTaxId, validateContactName } from '@/components/shared/validation';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {   Select,   SelectContent,   SelectItem,   SelectTrigger,   SelectValue, } from "@/components/ui/select";
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
import LoadingSpinner from "@/components/shared/LoadingSpinner";
 export default function ClientForm() {   const navigate = useNavigate();
  const { user, isLoadingAuth } = useAuth();
  const { id: routeId } = useParams();
  const urlParams = new URLSearchParams(window.location.search);
  const clientId = routeId || urlParams.get('id');
  const isEditing = !!clientId;
   const [loading, setLoading] = useState(isEditing);
  const [saving, setSaving] = useState(false);
  const [configs, setConfigs] = useState({});
  const [formData, setFormData] = useState({     client_type: 'private',     company_name: '',     contact_name: '',     tax_id: '',     phone: '',     email: '',     address: '',     city: '',     zip_code: '',     notes: '',     status: 'active',     tags: []   });
  const [validationErrors, setValidationErrors] = useState({});
  const [validationSuccess, setValidationSuccess] = useState({});
  const [duplicateWarning, setDuplicateWarning] = useState(null);
   useEffect(() => {     if (!user) return;
    loadConfigs();
  }, [user]);
   useEffect(() => {     if (isEditing && user) {       loadClient();
    }   }, [clientId, user, isEditing]);
   useEffect(() => {     // Reset status when client type changes if current status is not valid for new type     if (formData.client_type) {       const validStatuses = getClientStatusOptions().map(s => s.value);
      if (!validStatuses.includes(formData.status)) {         setFormData(prev => ({ ...prev, status: 'active' }));
      }     }   }, [formData.client_type]);
   const loadConfigs = async () => {     try {       if (!user) return;
      const { data, error } = await supabase         .from('app_configs')         .select('config_type, config_data')         .eq('owner_id', user.id);
      if (error) throw error;
      const configsData = data || [];
      const configMap = {};
      configsData.forEach(config => {         if (config.config_data?.statuses) {           configMap[config.config_type] = config.config_data.statuses;
        }       });
      setConfigs(configMap);
    } catch (error) {       console.error('Error loading configs:', error);
    }   };
   const getClientStatusOptions = () => {     const configType = formData.client_type === 'company' ? 'client_statuses_company' :                        formData.client_type === 'customer_service' ? 'client_statuses_customer_service' :                       'client_statuses_private';
    return configs[configType] || [       { value: 'active', label: 'פעיל' },       { value: 'inactive', label: 'לא פעיל' }     ];
  };
   const ensureCustomerServiceTag = () => {     if (formData.client_type === 'customer_service') {       const tags = formData.tags || [];
      if (!tags.includes('שירות לקוחות')) {         return [...tags, 'שירות לקוחות'];
      }     }     return formData.tags || [];
  };
   const loadClient = async () => {     if (!user || !clientId) return;
    try {       const { data, error } = await supabase         .from('clients')         .select('*')         .eq('id', clientId)         .eq('owner_id', user.id)         .single();
       if (error) throw error;
       if (data) {         setFormData({           client_type: data.client_type || 'private',           company_name: data.company_name || '',           contact_name: data.contact_name || data.fullName || '',           tax_id: data.tax_id || '',           phone: data.phone || '',           email: data.email || '',           address: data.address || '',           city: data.city || '',           zip_code: data.zip_code || '',           notes: data.notes || '',           status: data.status || 'active',           tags: data.tags || []         });
      }     } catch (error) {       console.error('Error loading client:', error);
    } finally {       setLoading(false);
    }   };
   const handleChange = (field, value) => {     setFormData(prev => ({ ...prev, [field]: value }));
         // Clear validation error when user starts typing     if (validationErrors[field]) {       setValidationErrors(prev => ({ ...prev, [field]: null }));
    }          // Real-time validation     if (field === 'phone') {       const result = validatePhone(value);
      if (!result.valid) {         setValidationErrors(prev => ({ ...prev, phone: result.error }));
        setValidationSuccess(prev => ({ ...prev, phone: false }));
      } else {         setValidationSuccess(prev => ({ ...prev, phone: true }));
        checkDuplicate('phone', value);
      }     } else if (field === 'email' && value) {       const result = validateEmail(value);
      if (!result.valid) {         setValidationErrors(prev => ({ ...prev, email: result.error }));
        setValidationSuccess(prev => ({ ...prev, email: false }));
      } else {         setValidationSuccess(prev => ({ ...prev, email: true }));
        checkDuplicate('email', value);
      }     } else if (field === 'tax_id' && value) {       const result = validateTaxId(value);
      if (!result.valid) {         setValidationErrors(prev => ({ ...prev, tax_id: result.error }));
        setValidationSuccess(prev => ({ ...prev, tax_id: false }));
      } else {         setValidationSuccess(prev => ({ ...prev, tax_id: true }));
      }     } else if (field === 'contact_name') {       const trimmedValue = value?.trim() || '';
      if (!trimmedValue) {         setValidationErrors(prev => ({ ...prev, contact_name: 'שם איש קשר/שם מלא הוא שדה חובה' }));
        setValidationSuccess(prev => ({ ...prev, contact_name: false }));
        return;
      }       const result = validateContactName(trimmedValue);
      if (!result.valid) {         setValidationErrors(prev => ({ ...prev, contact_name: result.error }));
        setValidationSuccess(prev => ({ ...prev, contact_name: false }));
      } else {         setValidationSuccess(prev => ({ ...prev, contact_name: true }));
      }     }   };
   const checkDuplicate = async (field, value) => {     if (!value || isEditing || !user) return;
         try {       const { data, error } = await supabase         .from('clients')         .select('id, contact_name, company_name')         .eq('owner_id', user.id)         .eq(field, value)         .limit(1);
       if (error) throw error;
       if (data && data.length > 0) {         setDuplicateWarning({           field,           client: data[0],           message: `${field === 'phone' ? '�����' : '������'} זה כבר קיים במערכת`         });
      } else {         setDuplicateWarning(null);
      }     } catch (error) {       console.error('Error checking duplicate:', error);
    }   };
   const handleSubmit = async (e) => {     e.preventDefault();
    if (!user) return;
         // Validate all fields     const phoneValidation = validatePhone(formData.phone);
    const emailValue = (formData.email || '').trim();
    const emailValidation = emailValue ? validateEmail(emailValue) : { valid: true };
    const taxIdValidation = validateTaxId(formData.tax_id);
    const trimmedContactName = (formData.contact_name || '').trim();
    const contactNameValidation = validateContactName(trimmedContactName);
         const errors = {};
    if (!phoneValidation.valid) errors.phone = phoneValidation.error;
    if (!emailValidation.valid) errors.email = emailValidation.error;
    if (!taxIdValidation.valid) errors.tax_id = taxIdValidation.error;
    if (!trimmedContactName) {       errors.contact_name = 'שם איש קשר/שם מלא הוא שדה חובה';
    } else if (!contactNameValidation.valid) {       errors.contact_name = contactNameValidation.error;
    }          if ((formData.client_type === 'company' || formData.client_type === 'customer_service') && !formData.company_name) {       errors.company_name = 'שם החברה הוא שדה חובה';
    }          if (Object.keys(errors).length > 0) {       setValidationErrors(errors);
      toast.error('שגיאה בשמירה', {         description: 'אנא מלא את כל השדות המסומנים באדום',         duration: 6000       });
      return;
    }      setSaving(true);
     try {       const submitData = {          ...formData,          contact_name: trimmedContactName,         tags: ensureCustomerServiceTag()        };
             if (isEditing) {         const { error } = await supabase           .from('clients')           .update(submitData)           .eq('id', clientId)           .eq('owner_id', user.id);
         if (error) throw error;
        toast.success('✓ הלקוח עודכן בהצלחה', {           description: `${submitData.client_type === 'company' ? submitData.company_name : submitData.contact_name} עודכן במערכת`,           duration: 4000         });
      } else {         const { data: newClient, error } = await supabase           .from('clients')           .insert([{ ...submitData, owner_id: user.id }])           .select('id')           .single();
         if (error) throw error;
        toast.success('✓ הלקוח נוצר בהצלחה', {           description: `${submitData.client_type === 'company' ? submitData.company_name : submitData.contact_name} נוסף למערכת`,           duration: 5000,           action: {             label: 'צור עבודה',             onClick: () => navigate(createPageUrl(`JobForm?client_id=${newClient?.id}`))           }         });
      }        navigate(createPageUrl('Clients'));
    } catch (error) {       console.error('Error saving client:', error);
      toast.error('✗ שגיאה בשמירה', {         description: 'אירעה שגיאה בשמירת הלקוח. נסה שוב',         duration: 6000       });
    } finally {       setSaving(false);
    }   };
   if (isLoadingAuth) return <LoadingSpinner />;
  if (!user) return null;
  if (loading) return <LoadingSpinner />;
   return (     <div dir="rtl" className="p-4 lg:p-8 max-w-3xl mx-auto">       {/* Header */}       <div className="flex items-center gap-4 mb-8">         <Button            variant="ghost"            size="icon"           onClick={() => navigate(-1)}           className="rounded-full"         >           <ArrowRight className="w-5 h-5" />         </Button>         <div>           <h1 className="text-2xl font-bold text-slate-800">             {isEditing ? 'עריכת לקוח' : 'לקוח חדש'}           </h1>           <p className="text-slate-500 mt-1">             {isEditing ? 'עדכן את פרטי הלקוח' : 'הוסף לקוח חדש למערכת'}           </p>         </div>       </div>        <form onSubmit={handleSubmit} className="space-y-6">         {/* Client Type */}         <Card className="border-0 shadow-sm">           <CardHeader>             <CardTitle className="text-lg">סוג לקוח</CardTitle>           </CardHeader>           <CardContent>             <Tabs value={formData.client_type} onValueChange={(v) => handleChange('client_type', v)}>               <TabsList className="grid w-full grid-cols-3 bg-slate-100">                 <TabsTrigger value="private" className="flex items-center gap-2">                   <User className="w-4 h-4" />                   פרטי                 </TabsTrigger>                 <TabsTrigger value="company" className="flex items-center gap-2">                   <Building2 className="w-4 h-4" />                   חברה                 </TabsTrigger>                 <TabsTrigger value="customer_service" className="flex items-center gap-2">                   <Headphones className="w-4 h-4" />                   שירות לקוחות                 </TabsTrigger>               </TabsList>             </Tabs>           </CardContent>         </Card>          {/* Basic Info */}         <Card className="border-0 shadow-sm">           <CardHeader>             <CardTitle className="text-lg">פרטים בסיסיים</CardTitle>           </CardHeader>           <CardContent className="space-y-4">             {(formData.client_type === 'company' || formData.client_type === 'customer_service') && (               <div className="space-y-2">                 <Label htmlFor="company_name">                   {formData.client_type === 'company' ? 'שם החברה *' : 'שם השירות *'}                 </Label>                 <div className="relative">                   <Building2 className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />                   <Input                     id="company_name"                     value={formData.company_name}                     onChange={(e) => handleChange('company_name', e.target.value)}                     placeholder={formData.client_type === 'company' ? 'שם החברה' : 'שם השירות'}                     className="pr-10"                     required                   />                 </div>               </div>             )}              <div className="space-y-2">               <Label htmlFor="contact_name">                 {formData.client_type === 'company' ? 'איש קשר *' : 'שם מלא *'}               </Label>               <div className="relative">                 <User className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />                 <Input                   id="contact_name"                   value={formData.contact_name}                   onChange={(e) => handleChange('contact_name', e.target.value)}                   placeholder={formData.client_type === 'company' ? 'שם איש הקשר' : 'שם מלא'}                   className={`pr-10 ${validationErrors.contact_name ? 'border-red-500' : validationSuccess.contact_name ? 'border-green-500' : ''}`}                   required                 />                 {validationSuccess.contact_name && (                   <CheckCircle className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-green-500" />                 )}               </div>               {validationErrors.contact_name && (                 <p className="text-xs text-red-600 flex items-center gap-1">                   <AlertCircle className="w-3 h-3" /> {validationErrors.contact_name}                 </p>               )}             </div>              <div className="grid sm:grid-cols-2 gap-4">               <div className="space-y-2">                 <Label htmlFor="phone">טלפון (וואטסאפ) *</Label>                 <div className="relative">                   <Phone className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />                   <Input                     id="phone"                     value={formData.phone}                     onChange={(e) => handleChange('phone', e.target.value)}                     placeholder="050-0000000"                     className={`pr-10 ${validationErrors.phone ? 'border-red-500' : validationSuccess.phone ? 'border-green-500' : ''}`}                     dir="ltr"                     required                   />                   {validationSuccess.phone && (                     <CheckCircle className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-green-500" />                   )}                 </div>                 {validationErrors.phone && (                   <p className="text-xs text-red-600 flex items-center gap-1">                     <AlertCircle className="w-3 h-3" /> {validationErrors.phone}                   </p>                 )}                 {duplicateWarning && duplicateWarning.field === 'phone' && (                   <div className="text-xs text-amber-600 flex items-center gap-1 bg-amber-50 p-2 rounded border border-amber-200">                     <AlertCircle className="w-3 h-3" />                     <span>{duplicateWarning.message} - </span>                     <button                       type="button"                       onClick={() => navigate(createPageUrl(`ClientDetails?id=${duplicateWarning.client.id}`))}                       className="underline font-medium hover:text-amber-700"                     >                       פתח לקוח קיים                     </button>                   </div>                 )}               </div>                <div className="space-y-2">                 <Label htmlFor="email">אימייל</Label>                 <div className="relative">                   <Mail className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />                   <Input                     id="email"                     type="email"                     value={formData.email}                     onChange={(e) => handleChange('email', e.target.value)}                     placeholder="email@example.com"                     className={`pr-10 ${validationErrors.email ? 'border-red-500' : validationSuccess.email ? 'border-green-500' : ''}`}                     dir="ltr"                   />                   {validationSuccess.email && (                     <CheckCircle className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-green-500" />                   )}                 </div>                 {validationErrors.email && (                   <p className="text-xs text-red-600 flex items-center gap-1">                     <AlertCircle className="w-3 h-3" /> {validationErrors.email}                   </p>                 )}                 {duplicateWarning && duplicateWarning.field === 'email' && (                   <div className="text-xs text-amber-600 flex items-center gap-1 bg-amber-50 p-2 rounded border border-amber-200">                     <AlertCircle className="w-3 h-3" />                     <span>{duplicateWarning.message} - </span>                     <button                       type="button"                       onClick={() => navigate(createPageUrl(`ClientDetails?id=${duplicateWarning.client.id}`))}                       className="underline font-medium hover:text-amber-700"                     >                       פתח לקוח קיים                     </button>                   </div>                 )}               </div>             </div>              <div className="space-y-2">               <Label htmlFor="tax_id">ח.פ / ת.ז (ללא מקפים)</Label>               <div className="relative">                 <Building2 className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />                 <Input                   id="tax_id"                   value={formData.tax_id}                   onChange={(e) => handleChange('tax_id', e.target.value)}                   placeholder="123456789"                   className={`pr-10 ${validationErrors.tax_id ? 'border-red-500' : validationSuccess.tax_id ? 'border-green-500' : ''}`}                   dir="ltr"                 />                 {validationSuccess.tax_id && (                   <CheckCircle className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-green-500" />                 )}               </div>               {validationErrors.tax_id && (                 <p className="text-xs text-red-600 flex items-center gap-1">                   <AlertCircle className="w-3 h-3" /> {validationErrors.tax_id}                 </p>               )}             </div>           </CardContent>         </Card>          {/* Address */}         <Card className="border-0 shadow-sm">           <CardHeader>             <CardTitle className="text-lg">כתובת</CardTitle>           </CardHeader>           <CardContent className="space-y-4">             <div className="space-y-2">               <Label htmlFor="address">כתובת</Label>               <div className="relative">                 <MapPin className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />                 <Input                   id="address"                   value={formData.address}                   onChange={(e) => handleChange('address', e.target.value)}                   placeholder="רחוב ומספר בית"                   className="pr-10"                 />               </div>             </div>              <div className="grid grid-cols-2 gap-4">               <div className="space-y-2">                 <Label htmlFor="city">עיר</Label>                 <Input                   id="city"                   value={formData.city}                   onChange={(e) => handleChange('city', e.target.value)}                   placeholder="שם העיר"                 />               </div>                <div className="space-y-2">                 <Label htmlFor="zip_code">מיקוד</Label>                 <Input                   id="zip_code"                   value={formData.zip_code}                   onChange={(e) => handleChange('zip_code', e.target.value)}                   placeholder="1234567"                   dir="ltr"                 />               </div>             </div>           </CardContent>         </Card>          {/* Notes */}         <Card className="border-0 shadow-sm">           <CardHeader>             <CardTitle className="text-lg">הערות</CardTitle>           </CardHeader>           <CardContent>             <Textarea               value={formData.notes}               onChange={(e) => handleChange('notes', e.target.value)}               placeholder="הערות על הלקוח..."               rows={4}             />           </CardContent>         </Card>          {/* Status */}         <Card className="border-0 shadow-sm">           <CardHeader>             <CardTitle className="text-lg">סטטוס</CardTitle>           </CardHeader>           <CardContent>             <Select value={formData.status} onValueChange={(v) => handleChange('status', v)}>               <SelectTrigger>                 <SelectValue />               </SelectTrigger>               <SelectContent>                 {getClientStatusOptions().map(option => (                   <SelectItem key={option.value} value={option.value}>                     {option.label}                   </SelectItem>                 ))}               </SelectContent>             </Select>           </CardContent>         </Card>          {/* Actions */}         <div className="flex gap-3 pt-4">           <Button              type="submit"              disabled={saving}             style={{ backgroundColor: '#00214d' }}             className="flex-1 hover:opacity-90"           >             {saving ? (               <>                 <Loader2 className="w-4 h-4 ml-2 animate-spin" />                 שומר...               </>             ) : (               <>                 <Save className="w-4 h-4 ml-2" />                 {isEditing ? 'שמור שינויים' : 'צור לקוח'}               </>             )}           </Button>           <Button              type="button"              variant="outline"             onClick={() => navigate(-1)}           >             ביטול           </Button>         </div>       </form>     </div>   );
}  
